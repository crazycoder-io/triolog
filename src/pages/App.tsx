import React from "react";
import {Grid, List, ListItemText, ListItem, CircularProgress} from "@material-ui/core";
import firebase from "../firebase";
import {Tool, LogPanel, NavBar, Collection} from "../components";
import types from "../types/DNDTypes";
import "../styles/App.css";

const db = firebase.default.firestore();

function App() {
    const [subjectList, setSubjectList] = React.useState<Array<{id: string; subject: string}> | []>([]);
    const [listLoading, setListLoading] = React.useState<boolean>(false);
    const [logs, setLogs] = React.useState<Array<{title: string; message: string; time: string}>>([]);

    const [workplace, setWorkplace] = React.useState<
        Array<{
            key: string;
            type: string;
            Component: JSX.Element;
            offset: {x: number | undefined; y: number | undefined};
        }>
    >([]);

    const addTool = (
        item: {key: string; type: string; Component: JSX.Element},
        offset: {x: number | undefined; y: number | undefined}
    ) => {
        if (item && item.key !== "") {
            setWorkplace(prev => [...prev, {key: item.key, type: item.type, Component: item.Component, offset}]);
            setLogs(prev => [
                ...prev,
                {title: "New Tool", message: "Added new tool - " + item.key, time: new Date().toUTCString()},
            ]);
        }
    };

    const [tools] = React.useState([
        {
            key: new Date().getTime().toString(),
            type: types.COLLECTION_COMPONENT,
            Component: <Collection disabled={true} />,
        },
        {
            key: (new Date().getTime() + 1).toString(),
            type: types.COLLECTION_COMPONENT,
            Component: <Collection disabled={true} />,
        },
    ]);

    const moveTool = (
        item: {key: string; type: string; Component: JSX.Element},
        offset: {x: number | undefined; y: number | undefined}
    ) => {
        if (item && item.key !== "") {
            const newItemList = workplace.filter(t => t.key !== item.key);
            setWorkplace([...newItemList, {key: item.key, type: item.type, Component: item.Component, offset}]);
            setLogs(prev => [
                ...prev,
                {
                    title: "Move Tool",
                    message: item.key + " moved to X:" + offset.x + " Y:" + offset.y,
                    time: new Date().toUTCString(),
                },
            ]);
        }
    };

    React.useEffect(() => {
        async function getSubjects() {
            setListLoading(true);
            const subjects = await db.collection("subjects").get();
            subjects.forEach(doc => {
                if (!subjectList.some(d => d.id === doc.id)) {
                    setSubjectList(prev => [...prev, {id: doc.id, subject: doc.data().subject}]);
                }
            });
            setListLoading(false);
        }

        getSubjects();
    }, []);

    return (
        <div className="container">
            {/* <Head>
                <title>Create Next App</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head> */}

            <Grid container>
                <Grid item xs={12}>
                    <NavBar />
                </Grid>
                <Grid container className="workPanel">
                    <Grid item md={2} className="listPanel">
                        <List component="data" aria-label="primary" className="list">
                            {listLoading && <CircularProgress />}
                            {subjectList.length > 0 &&
                                subjectList.map(subject => (
                                    <ListItem button key={subject.id} className="list-item">
                                        <ListItemText
                                            className="list-item-text"
                                            color="black"
                                            primary={subject.subject}
                                        />
                                    </ListItem>
                                ))}
                        </List>
                    </Grid>
                    <Grid item container direction="column" md={8}>
                        <Grid item className="designPanel">
                            <div className="workField">
                                {workplace.map(item => (
                                    <div
                                        key={item.key + new Date().toUTCString()}
                                        style={{
                                            position: item.offset.x ? "absolute" : "initial",
                                            left: item.offset.x ? item.offset.x + "px" : "",
                                            top: item.offset.y ? item.offset.y + "px" : "",
                                        }}>
                                        <Tool item={item} onDrop={moveTool} />
                                    </div>
                                ))}
                            </div>
                        </Grid>
                        <Grid item className="logPanel">
                            <LogPanel logs={logs} />
                        </Grid>
                    </Grid>
                    <Grid item md={2} className="toolPanel">
                        <ul>
                            {tools.map(({Component, type, key}, index) => (
                                <Tool key={index} onDrop={addTool} item={{type, key, Component}} />
                            ))}
                        </ul>
                    </Grid>
                </Grid>
            </Grid>
        </div>
    );
}

export default App;
